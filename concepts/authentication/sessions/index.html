<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
  <head>
    <title>Documentation: Sessions</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="canonical" href="https://www.passportjs.org/concepts/authentication/sessions/">
    <link rel="manifest" href="/manifest.webmanifest"/>
    <meta name="theme-color" content="#35DF79"/>
    <link rel="shortcut icon" href="/images/favicon/favicon.ico"/>
    <link rel="icon" sizes="16x16" type="image/png" href="/images/favicon/favicon-16x16.png"/>
    <link rel="icon" sizes="32x32" type="image/png" href="/images/favicon/favicon-32x32.png"/>
    <link rel="icon" sizes="36x36" type="image/png" href="/images/favicon/android-icon-36x36.png"/>
    <link rel="icon" sizes="48x48" type="image/png" href="/images/favicon/android-icon-48x48.png"/>
    <link rel="icon" sizes="70x70" type="image/png" href="/images/favicon/ms-icon-70x70.png"/>
    <link rel="icon" sizes="72x72" type="image/png" href="/images/favicon/android-icon-72x72.png"/>
    <link rel="icon" sizes="96x96" type="image/png" href="/images/favicon/android-icon-96x96.png"/>
    <link rel="icon" sizes="144x144" type="image/png" href="/images/favicon/ms-icon-144x144.png"/>
    <link rel="icon" sizes="150x150" type="image/png" href="/images/favicon/ms-icon-150x150.png"/>
    <link rel="icon" sizes="192x192" type="image/png" href="/images/favicon/android-icon-192x192.png"/>
    <link rel="icon" sizes="310x310" type="image/png" href="/images/favicon/ms-icon-310x310.png"/>
    <link rel="apple-touch-icon" href="/images/favicon/apple-icon-57x57.png"/>
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png"/>
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png"/>
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png"/>
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png"/>
    <meta name="msapplication-config" content="/browserconfig.xml"/>
    <meta name="msapplication-TileColor" content="#35DF79"/>
    <meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png"/>
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="Documentation: Sessions"/>
    <meta property="og:url" content="https://www.passportjs.org/concepts/authentication/sessions/"/>
    <meta property="og:image" content="https://www.passportjs.org/images/facebook-card.png"/>
    <meta property="og:image:type" content="image/png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <meta property="og:site_name" content="Passport.js"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="@passportjs"/>
    <meta name="twitter:title" content="Documentation: Sessions"/>
    <meta name="twitter:image" content="https://www.passportjs.org/images/twitter-card.png"/>
    <meta name="flattr:id" content="d5znvd"/>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-73332146-2', 'auto');
      ga('send', 'pageview');
    </script>
    <!--+google-tag-manager('GTM-M5S3PH')-->
    <!--link(type='text/css', rel='stylesheet', href='http://fast.fonts.net/cssapi/7527d73a-ebfe-45db-a201-ff2812df4b18.css')-->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css">
    <link rel="stylesheet" href="/assets/styles/all.css">
    <script data-main="/script/main" src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>
  </head>
  <body>
    <div id="container"><span id="top"></span>
      <div id="toolbar">
        <div class="toolbar-search">
          <form action="/search">
            <button type="submit"></button>
            <input type="text" name="q" placeholder="Search for Strategies">
          </form>
        </div>
        <div class="toolbar-social">
          <ul>
            <li class="facebook"><a href="https://www.facebook.com/passportjs" target="_blank"></a></li>
            <li class="twitter"><a href="https://twitter.com/passportjs" target="_blank"></a></li>
            <li class="github"><a href="https://github.com/jaredhanson/passport" target="_blank"><span class="count">0</span></a></li>
          </ul>
        </div>
      </div>
      <nav id="menu"><a class="menu-logo" href="/" title="Passport.js"></a>
        <div class="menu-trigger"><span></span></div>
        <div class="menu-items">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/docs/">Documentation</a></li>
            <li><a href="/features/">Features</a></li>
            <li><a href="/packages/">Strategies</a></li>
            <li><a href="/sponsors/">Sponsors</a></li>
          </ul><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=passportjsorg" id="_carbonads_js"></script>
        </div>
      </nav>
      <div id="content">
        <div class="book" id="book">
          <div class="toc">
            <nav data-accordion-group="">
              <div class="accordion" data-accordion="">
                <h5 data-control=""><i class="icon-budicon-461"></i><a href="/concepts/authentication/middleware/"></a>General</h5>
                <ul data-content="">
                  <li><a href="/concepts/authentication/middleware/">Middleware</a></li>
                  <li><a href="/concepts/authentication/strategies/">Strategies</a></li>
                  <li><a class="active" href="/concepts/authentication/sessions/">Sessions</a></li>
                  <li><a href="/concepts/authentication/password/">Username &amp; Password</a></li>
                </ul>
              </div>
              <div class="accordion" data-accordion="">
                <h5 data-control=""><i class="icon-budicon-461"></i><a href="/concepts/authentication/facebook/"></a>Social</h5>
                <ul data-content="">
                  <li><a href="/concepts/authentication/facebook/">Facebook</a></li>
                  <li><a href="/concepts/authentication/google/">Google</a></li>
                  <li><a href="/concepts/authentication/twitter/">Twitter</a></li>
                </ul>
              </div>
              <div class="accordion" data-accordion="">
                <h5 data-control=""><i class="icon-budicon-461"></i><a href="/concepts/authentication/oauth/"></a>Federated</h5>
                <ul data-content="">
                  <li><a href="/concepts/authentication/oauth/">OAuth</a></li>
                  <li><a href="/concepts/authentication/openid/">OpenID</a></li>
                </ul>
              </div>
              <div class="accordion" data-accordion="">
                <h5 data-control=""><i class="icon-budicon-461"></i><a href="/concepts/authentication/login/"></a>Sessions</h5>
                <ul data-content="">
                  <li><a href="/concepts/authentication/login/">Log In</a></li>
                  <li><a href="/concepts/authentication/logout/">Log Out</a></li>
                </ul>
              </div>
              <div class="accordion" data-accordion="">
                <h5 data-control=""><i class="icon-budicon-461"></i><a href="/concepts/authentication/http-bearer/"></a>API</h5>
                <ul data-content="">
                  <li><a href="/concepts/authentication/http-bearer/">Bearer</a></li>
                  <li><a href="/concepts/authentication/http-oauth/">OAuth</a></li>
                  <li><a href="/concepts/authentication/http-basic/">Basic</a></li>
                </ul>
              </div>
            </nav>
          </div><a id="go-top" href="#top"><i class="icon-budicon-462"></i></a>
          <div class="contents">
            <section class="chapter"><h1 id="sessions">Sessions</h1>
<p>A web application needs the ability to identify users as they browse from page
to page.  This series of requests and responses, each associated with the same
user, is known as a session.</p>
<p>HTTP is a stateless protocol, meaning that each request to an application can be
understood in isolation - without any context from previous requests.  This
poses a challenge for web applications with logged in users, as the
authenticated user needs to be remembered across subsequent requests as they
navigate the application.</p>
<p>To solve this challenge, web applications make use of sessions, which allow
state to be maintained between the application server and the user&#39;s browser.  A
session is established by setting an <a href="https://en.wikipedia.org/wiki/HTTP_cookie">HTTP cookie</a>
in the browser, which the browser then transmits to the server on every request.
The server uses the value of the cookie to retrieve information it needs across
multiple requests.  In effect, this creates a stateful protocol on top of HTTP.</p>
<p>While sessions are used to maintain authentication state, they can also be used
by applications to maintain other state unrelated to authentication.  Passport
is carefully designed to isolate authentication state, referred to as a login
session, from other state that may be stored in the session.</p>
<p>Applications must initialize session support in order to make use of login
sessions.  In an <a href="https://expressjs.com/">Express</a> app, session support is added
by using  <a href="https://github.com/expressjs/session"><code>express-session</code></a> middleware.</p>
<pre><code class="javascript"><span class="keyword">var</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);

app.<span class="title function_">use</span>(<span class="title function_">session</span>({
  <span class="attr">secret</span>: <span class="string">&#x27;keyboard cat&#x27;</span>,
  <span class="attr">resave</span>: <span class="literal">false</span>,
  <span class="attr">saveUninitialized</span>: <span class="literal">false</span>,
  <span class="attr">cookie</span>: { <span class="attr">secure</span>: <span class="literal">true</span> }
}));
</code></pre><p>To maintain a login session, Passport serializes and deserializes user
information to and from the session.  The information that is stored is
determined by the application, which supplies a <code>serializeUser</code> and a
<code>deserializeUser</code> function.</p>
<pre><code class="javascript">passport.<span class="title function_">serializeUser</span>(<span class="keyword">function</span>(<span class="params">user, cb</span>) {
  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) {
    <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="literal">null</span>, {
      <span class="attr">id</span>: user.<span class="property">id</span>,
      <span class="attr">username</span>: user.<span class="property">username</span>,
      <span class="attr">picture</span>: user.<span class="property">picture</span>
    });
  });
});

passport.<span class="title function_">deserializeUser</span>(<span class="keyword">function</span>(<span class="params">user, cb</span>) {
  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) {
    <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="literal">null</span>, user);
  });
});
</code></pre><p>A login session is established upon a user successfully authenticating using a
credential.  The following route will authenticate a user using a username and
password.  If successfully verified, Passport will call the <code>serializeUser</code>
function, which in the above example is storing the user&#39;s ID, username, and
picture.  Any other properties of the user, such as an address or birthday, are
not stored.</p>
<pre><code class="javascript">app.<span class="title function_">post</span>(<span class="string">&#x27;/login/password&#x27;</span>,
  passport.<span class="title function_">authenticate</span>(<span class="string">&#x27;local&#x27;</span>, { <span class="attr">failureRedirect</span>: <span class="string">&#x27;/login&#x27;</span>, <span class="attr">failureMessage</span>: <span class="literal">true</span> }),
  <span class="keyword">function</span>(<span class="params">req, res</span>) {
    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/~&#x27;</span> + req.<span class="property">user</span>.<span class="property">username</span>);
  });
</code></pre><p>As the user navigates from page to page, the session itself can be authenticated
using the built-in <code>session</code> strategy.  Because an authenticated session is
typically needed for the majority of routes in an application, it is common to
use this as <a href="https://expressjs.com/en/guide/using-middleware.html#middleware.application">application-level middleware</a>,
after <code>session</code> middleware.</p>
<pre><code class="javascript">app.<span class="title function_">use</span>(<span class="title function_">session</span>(<span class="comment">/* ... */</span>);
app.<span class="title function_">use</span>(passport.<span class="title function_">authenticate</span>(<span class="string">&#x27;session&#x27;</span>));
</code></pre><p>This can also be accomplished, more succinctly, using the <code>passport.session()</code>
alias.</p>
<pre><code class="javascript">app.<span class="title function_">use</span>(<span class="title function_">session</span>(<span class="comment">/* ... */</span>);
app.<span class="title function_">use</span>(passport.<span class="title function_">session</span>());
</code></pre><p>When the session is authenticated, Passport will call the <code>deserializeUser</code>
function, which in the above example is yielding the previously stored user ID,
username, and picture.  The <code>req.user</code> property is then set to the yielded
information.</p>
<p>There is an inherent tradeoff between the amount of data stored in a session and
database load incurred when authenticating a session.  This tradeoff is
particularly pertinent when session data is stored on the client, rather than
the server, using a package such as <a href="https://github.com/expressjs/cookie-session"><code>cookie-session</code></a>.
Storing less data in the session will require heavier queries to a database to
obtain that information.  Conversely, storing more data in the session reduces
database queries while potentially exceeding the maximum amount of data that can
be stored in a cookie.</p>
<p>This tradeoff is controlled by the application and the <code>serializeUser</code> and
<code>deserializeUser</code> functions it supplies.  In contrast to the above example, the
following example minimizes the data stored in the session at the expense of
querying the database for every request in which the session is authenticated.</p>
<pre><code class="javascript">passport.<span class="title function_">serializeUser</span>(<span class="keyword">function</span>(<span class="params">user, cb</span>) {
  process.<span class="title function_">nextTick</span>(<span class="keyword">function</span>(<span class="params"></span>) {
    <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="literal">null</span>, user.<span class="property">id</span>);
  });
});

passport.<span class="title function_">deserializeUser</span>(<span class="keyword">function</span>(<span class="params">id, cb</span>) {
  db.<span class="title function_">get</span>(<span class="string">&#x27;SELECT * FROM users WHERE id = ?&#x27;</span>, [ id ], <span class="keyword">function</span>(<span class="params">err, user</span>) {
    <span class="keyword">if</span> (err) { <span class="keyword">return</span> <span class="title function_">cb</span>(err); }
    <span class="keyword">return</span> <span class="title function_">cb</span>(<span class="literal">null</span>, user);
  });
});
</code></pre><p>To balance this tradeoff, it is recommended that any user information needed on
<em>every</em> request to the application be stored in the session.  For example, if
the application displays a user element containing the user&#39;s name, email
address, and photo on every page, that information should be stored in the
session to eliminate what would otherwise be frequent database queries.
Specific routes, such as a checkout page, that need additional information such
as a shipping address, can query the database for that data.</p>
</section>
          </div>
        </div>
      </div>
    </div>
    <div class="search-con">
      <div class="head"><span class="close-ico"></span>
        <div class="hold">
          <h2>SEARCH FOR STRATEGIES</h2>
          <form action="/">
            <input value="" type="text" name="strategy" placeholder="Start typing" autocomplete="off">
          </form>
          <p class="info-line"><span>0</span>STRATEGIES</p>
        </div>
      </div>
      <div class="results">
        <section></section>
      </div>
    </div>
    <!--+google-tag-manager-noscript('GTM-M5S3PH')-->
  </body>
</html>