<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en">
  <head>
    <title>passport-ufshib</title>
    <meta charset="utf-8">
    <meta name="description" content="Passport authentication strategy for University of Florida's Shibboleth service">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="canonical" href="https://www.passportjs.org/packages/passport-ufshib/">
    <link rel="manifest" href="/manifest.webmanifest"/>
    <meta name="theme-color" content="#35DF79"/>
    <link rel="shortcut icon" href="/images/favicon/favicon.ico"/>
    <link rel="icon" sizes="16x16" type="image/png" href="/images/favicon/favicon-16x16.png"/>
    <link rel="icon" sizes="32x32" type="image/png" href="/images/favicon/favicon-32x32.png"/>
    <link rel="icon" sizes="36x36" type="image/png" href="/images/favicon/android-icon-36x36.png"/>
    <link rel="icon" sizes="48x48" type="image/png" href="/images/favicon/android-icon-48x48.png"/>
    <link rel="icon" sizes="70x70" type="image/png" href="/images/favicon/ms-icon-70x70.png"/>
    <link rel="icon" sizes="72x72" type="image/png" href="/images/favicon/android-icon-72x72.png"/>
    <link rel="icon" sizes="96x96" type="image/png" href="/images/favicon/android-icon-96x96.png"/>
    <link rel="icon" sizes="144x144" type="image/png" href="/images/favicon/ms-icon-144x144.png"/>
    <link rel="icon" sizes="150x150" type="image/png" href="/images/favicon/ms-icon-150x150.png"/>
    <link rel="icon" sizes="192x192" type="image/png" href="/images/favicon/android-icon-192x192.png"/>
    <link rel="icon" sizes="310x310" type="image/png" href="/images/favicon/ms-icon-310x310.png"/>
    <link rel="apple-touch-icon" href="/images/favicon/apple-icon-57x57.png"/>
    <link rel="apple-touch-icon" sizes="60x60" href="/images/favicon/apple-icon-60x60.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="/images/favicon/apple-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="76x76" href="/images/favicon/apple-icon-76x76.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="/images/favicon/apple-icon-114x114.png"/>
    <link rel="apple-touch-icon" sizes="120x120" href="/images/favicon/apple-icon-120x120.png"/>
    <link rel="apple-touch-icon" sizes="144x144" href="/images/favicon/apple-icon-144x144.png"/>
    <link rel="apple-touch-icon" sizes="152x152" href="/images/favicon/apple-icon-152x152.png"/>
    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-icon-180x180.png"/>
    <meta name="msapplication-config" content="/browserconfig.xml"/>
    <meta name="msapplication-TileColor" content="#35DF79"/>
    <meta name="msapplication-TileImage" content="/images/favicon/ms-icon-144x144.png"/>
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="passport-ufshib"/>
    <meta property="og:description" content="Passport authentication strategy for University of Florida's Shibboleth service"/>
    <meta property="og:url" content="https://www.passportjs.org/packages/passport-ufshib/"/>
    <meta property="og:image" content="https://www.passportjs.org/images/facebook-card.png"/>
    <meta property="og:image:type" content="image/png"/>
    <meta property="og:image:width" content="1200"/>
    <meta property="og:image:height" content="630"/>
    <meta property="og:site_name" content="Passport.js"/>
    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:site" content="@passportjs"/>
    <meta name="twitter:title" content="passport-ufshib"/>
    <meta name="twitter:description" content="Passport authentication strategy for University of Florida's Shibboleth service"/>
    <meta name="twitter:image" content="https://www.passportjs.org/images/twitter-card.png"/>
    <meta name="flattr:id" content="d5znvd"/>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      
      ga('create', 'UA-73332146-2', 'auto');
      ga('send', 'pageview');
    </script>
    <!--+google-tag-manager('GTM-M5S3PH')-->
    <!--link(type='text/css', rel='stylesheet', href='http://fast.fonts.net/cssapi/7527d73a-ebfe-45db-a201-ff2812df4b18.css')-->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.5/styles/default.min.css">
    <link rel="stylesheet" href="/assets/styles/all.css">
    <script data-main="/script/main" src="//cdnjs.cloudflare.com/ajax/libs/require.js/2.3.5/require.js"></script>
  </head>
  <body>
    <div id="container"><span id="top"></span>
      <div id="toolbar">
        <div class="toolbar-search">
          <form action="/search">
            <button type="submit"></button>
            <input type="text" name="q" placeholder="Search for Strategies">
          </form>
        </div>
        <div class="toolbar-social">
          <ul>
            <li class="facebook"><a href="https://www.facebook.com/passportjs" target="_blank"></a></li>
            <li class="twitter"><a href="https://twitter.com/passportjs" target="_blank"></a></li>
            <li class="github"><a href="https://github.com/jaredhanson/passport" target="_blank"><span class="count">0</span></a></li>
          </ul>
        </div>
      </div>
      <nav id="menu"><a class="menu-logo" href="/" title="Passport.js"></a>
        <div class="menu-trigger"><span></span></div>
        <div class="menu-items">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/docs/">Documentation</a></li>
            <li><a href="/features/">Features</a></li>
            <li><a href="/packages/">Strategies</a></li>
          </ul><script async type="text/javascript" src="//cdn.carbonads.com/carbon.js?zoneid=1673&serve=C6AILKT&placement=passportjsorg" id="_carbonads_js"></script>
        </div>
      </nav>
      <div id="content">
        <div class="package hproduct" id="package">
          <div class="description"><h1 id="-passport-ufshib">##Passport-UFshib</h1>
<p>Passport authentication strategy for University of Florida&#39;s Shibboleth service.</p>
<p>This module was cloned from David Stearns <a href="https://github.com/drstearns/passport-uwshib">https://github.com/drstearns/passport-uwshib</a> and then modified considerably.</p>
<p>This module currently uses my fork of the <a href="https://github.com/bergie/passport-saml">passport-saml</a> module located: <a href="https://github.com/crohead13/passport-saml">https://github.com/crohead13/passport-saml</a></p>
<p>You must register your SP with <a href="http://identity.it.ufl.edu/process/technologies/shibboleth/">UF IAM</a></p>
<h2 id="-installation">##Installation</h2>
<p>  npm install passport-ufshib</p>
<p>or if using a <a href="https://www.npmjs.org/doc/package.json.html">package.json file</a>, add this line to your dependencies hash:</p>
<p>  &quot;passport-ufshib&quot;: &quot;*&quot;</p>
<h2 id="-usage">##Usage</h2>
<p>This module provides a Strategy for the <a href="http://passportjs.org/">Passport</a> framework, which is typically used with <a href="http://expressjs.com/">Express</a>. Thus, there are several modules you need to require in your server script in addition to this module.</p>
<pre><code>  <span class="keyword">var</span> http         = <span class="built_in">require</span>(<span class="string">'http'</span>);                     <span class="comment">//http server</span>
  <span class="keyword">var</span> https        = <span class="built_in">require</span>(<span class="string">'https'</span>);                    <span class="comment">//https server</span>
  <span class="keyword">var</span> fs           = <span class="built_in">require</span>(<span class="string">'fs'</span>);                       <span class="comment">//file system</span>
  <span class="keyword">var</span> express      = <span class="built_in">require</span>(<span class="string">"express"</span>);                  <span class="comment">//express middleware</span>
  <span class="keyword">var</span> morgan       = <span class="built_in">require</span>(<span class="string">'morgan'</span>);                   <span class="comment">//logger for express</span>
  <span class="keyword">var</span> bodyParser   = <span class="built_in">require</span>(<span class="string">'body-parser'</span>);              <span class="comment">//body parsing middleware</span>
  <span class="keyword">var</span> cookieParser = <span class="built_in">require</span>(<span class="string">'cookie-parser'</span>);            <span class="comment">//cookie parsing middleware</span>
  <span class="keyword">var</span> session      = <span class="built_in">require</span>(<span class="string">'express-session'</span>);          <span class="comment">//express session management</span>
  <span class="keyword">var</span> passport     = <span class="built_in">require</span>(<span class="string">'passport'</span>);                 <span class="comment">//authentication middleware</span>
  <span class="keyword">var</span> ufshib       = <span class="built_in">require</span>(<span class="string">'passport-ufshib'</span>);          <span class="comment">//UF Shibboleth auth strategy</span>
</code></pre><p>  You must create a shibboleth2.json file and locate it in a ./config directory off the root of your server.
  Example shibboleth2.json contents:</p>
<pre><code>  {
      <span class="attr">"idp_entrypoint"</span>: <span class="string">"https://{IDP_HOST}/idp/profile/SAML2/Redirect/SSO"</span>,
      <span class="attr">"domain"</span>: <span class="string">"your.website.ufl.edu"</span>,
       <span class="attr">"entityId"</span> :<span class="string">"urn:edu:ufl:dev:00000"</span>,
       <span class="attr">"cert_path"</span>: <span class="string">"./security/server-cert.pem"</span>,
       <span class="attr">"pvt_key_path"</span>: <span class="string">"./security/server-pvk.pem"</span>,
       <span class="attr">"attribute_path"</span>: <span class="string">"./config/attribute-map.xml"</span>,
       <span class="attr">"status_401_route"</span>: <span class="string">"/api"</span>
  }
</code></pre><p>  Also place a current attribute-map.xml file in the ./config directory.  The location to place this is configurable from within the shibboleth2.json file.</p>
<p>  You must use openssl to create a self signed certificate and private key pair to use to encrypt traffic with the IDP. The paths to where you put your cert/key pair is configurable in the shibboleth2.json file as well.  I put them in another directory ./security located off the root of the server as well.</p>
<p>  The status_401_route object allows you to have different redirect behavior for api routes.  In angularjs it is not convenient to call an api and get redirected to a login page for an expired session. So this allows you to configure a route that starts with /api, for example, and have it return a 401 instead of a logon page redirect.  This will save you XSS errors in your users browser.  Typically when you recieve an api error with status 401, you would reload the entire page, triggering a redirect to the logon page at the IDP.</p>
<p>  <code>&quot;status_401_route&quot;: &quot;/api&quot;</code></p>
<p>  The script creates the UF Shibboleth Strategy, and tells Passport to use it.</p>
<pre><code>    <span class="keyword">var</span> strategy = <span class="keyword">new</span> ufshib.Strategy({
        callbackUrl: loginCallbackUrl,
        forced: <span class="keyword">true</span>
    });

    passport.<span class="keyword">use</span>(<span class="title">strategy</span>);
</code></pre><p>You will typically want to use sessions to allow users to authenticate only once per-sesion. The next functions are called by Passport to serialize and deserialize the user to the session. As noted in the comments, you would typically want to serialize only the unique ID (<code>.netID</code>) and reconstitute the user from your database during deserialzie. But to keep things simple, the script serializes the entire user and deserializes it again.</p>
<pre><code>    passport.serialize<span class="constructor">User(<span class="params">function</span>(<span class="params">user</span>, <span class="params">done</span>)</span>{
        <span class="keyword">done</span>(null, user);
    });

    passport.deserialize<span class="constructor">User(<span class="params">function</span>(<span class="params">user</span>, <span class="params">done</span>)</span>{
        <span class="keyword">done</span>(null, user);
    });
</code></pre><p>Next, the script registers a few routes to handle login, the login callback, and the standard metadata. This module provides implementations for the metadata route, and you use passport.authenticate for the login and login callback routes. The login route will redirect the user to the UW single sign-on page, and the UW IdP will then redirect the user back to the login callback route.</p>
<pre><code>  <span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span><span class="regexp">//</span>
  <span class="regexp">//</span> login, login callback, and metadata routes
  <span class="regexp">//</span>
  app.get(loginUrl, passport.authenticate(strategy.name), ufshib.backToUrl());
  app.post(loginCallbackUrl, passport.authenticate(strategy.name), ufshib.backToUrl());
  app.get(ufshib.urls.metadata, ufshib.metadataRoute(strategy));

  app.use(ufshib.ensureAuth(loginUrl));
</code></pre><p>The <code>ufshib.backToUrl()</code> is a convenience middleware that will redirect the browser back to the URL that was originally requested before authentication.</p>
<p>Lastly, the script tells Express to use the <code>ensureAuth()</code> middleware provided by this module to secure all routes declared after this.</p>
<pre><code>    <span class="comment">//secure all routes following this</span>
    app.<span class="keyword">use</span>(<span class="title">ufshib</span>.<span class="title">ensureAuth</span>(<span class="title">loginUrl</span>));
</code></pre><p>Any route requested after this middleware will require authentication. When requested, those routes will automatically redirect to the <code>loginUrl</code> if the user has not already authenticated. After successful authentication, the browser will be redirected back to the original URL, and the user information will be available via the <code>.user</code> property on the request object.</p>
<p>Note that <code>ensureAuth</code> can also be used to selectively secure routes. For example:</p>
<pre><code>    app.get('protected/resource', ensureAuth(loginUrl), function(req, res) {
        //<span class="keyword">user</span> <span class="title">has</span> authenticated, do normal route processing
        //<span class="keyword">user</span> <span class="title">is</span> available via req.<span class="keyword">user</span>
    <span class="title">});</span>
</code></pre></div>
          <div class="metadata">
            <div class="install"><code>npm install <span class="fn">passport-ufshib</span></code></div>
            <ul>
              <li><span class="version">0.1.8</span> published <abbr class="updated" title="2022-06-01T07:03:00Z">6 days ago</abbr></li>
              <li><a class="url" href="https://github.com/crohead13/passport-ufshib">https://www.ufl.edu</a></li>
              <li><a rel="licence" href="http://www.opensource.org/licenses/MIT">MIT License</a></li>
            </ul>
            <ul>
              <li><b>1</b> downloads in the last day</li>
              <li><b>5</b> downloads in the last week</li>
              <li><b>20</b> downloads in the last month</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="search-con">
      <div class="head"><span class="close-ico"></span>
        <div class="hold">
          <h2>SEARCH FOR STRATEGIES</h2>
          <form action="/">
            <input value="" type="text" name="strategy" placeholder="Start typing" autocomplete="off">
          </form>
          <p class="info-line"><span>0</span>STRATEGIES</p>
        </div>
      </div>
      <div class="results">
        <section></section>
      </div>
    </div>
    <!--+google-tag-manager-noscript('GTM-M5S3PH')-->
  </body>
</html>